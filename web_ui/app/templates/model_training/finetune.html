{% extends "shared/layout.html" %}

{% block title %}Finetune Model{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('model_training.index') }}">Model Training</a></li>
            <li class="breadcrumb-item active" aria-current="page">Finetune Model</li>
        </ol>
    </nav>

    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Finetune Existing Model</h4>
        </div>
        <div class="card-body">
            <form id="finetuneModelForm">
                <div class="mb-3">
                    <label for="modelName" class="form-label">New Model Name</label>
                    <input type="text" class="form-control" id="modelName" name="model_name" required>
                    <div class="form-text">Give your finetuned model a descriptive name</div>
                </div>

                <div class="mb-3">
                    <label for="baseModel" class="form-label">Select Base Model</label>
                    <select class="form-select" id="baseModel" name="base_model" required>
                        <option value="" selected disabled>Choose a base model</option>
                        <!-- This would be populated with existing models -->
                        <option value="example_model">Example Model (placeholder)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="dataset" class="form-label">Select Dataset for Finetuning</label>
                    <select class="form-select" id="dataset" name="dataset" required>
                        <option value="" selected disabled>Choose a dataset</option>
                        {% for dataset in datasets %}
                        <option value="{{ dataset.name if dataset is mapping else dataset }}">{{ dataset.name if dataset is mapping else dataset }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">
                        Don't see your dataset? <a href="{{ url_for('model_training.create_dataset') }}">Create a new dataset</a>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="epochs" class="form-label">Number of Epochs</label>
                        <input type="number" class="form-control" id="epochs" name="epochs" min="1" value="5" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="batchSize" class="form-label">Batch Size</label>
                        <input type="number" class="form-control" id="batchSize" name="batch_size" min="1" value="16" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="learningRate" class="form-label">Learning Rate</label>
                    <input type="number" class="form-control" id="learningRate" name="learning_rate" min="0.00001" step="0.00001" value="0.0001" required>
                    <div class="form-text">Lower learning rates are usually better for finetuning</div>
                </div>

                <div class="mb-3">
                    <label for="frozenLayers" class="form-label">Frozen Layers</label>
                    <input type="number" class="form-control" id="frozenLayers" name="frozen_layers" min="0" value="5" required>
                    <div class="form-text">Number of layers to freeze (not update) during finetuning</div>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="useAugmentation" name="use_augmentation" checked>
                    <label class="form-check-label" for="useAugmentation">Use Data Augmentation</label>
                </div>

                <div id="finetuningProgress" class="d-none">
                    <div class="mb-3">
                        <label class="form-label">Finetuning Progress</label>
                        <div class="progress" style="height: 20px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div id="finetuningStatus" class="alert alert-info">Preparing finetuning environment...</div>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('model_training.index') }}" class="btn btn-outline-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Start Finetuning</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('finetuneModelForm');
        const progressSection = document.getElementById('finetuningProgress');
        const progressBar = document.getElementById('progressBar');
        const finetuningStatus = document.getElementById('finetuningStatus');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show progress section
            progressSection.classList.remove('d-none');
            submitBtn.disabled = true;
            
            // Collect form data
            const formData = new FormData(form);
            
            // This would be replaced with actual backend communication
            // For now, we'll just simulate progress
            let progress = 0;
            const interval = setInterval(function() {
                progress += 5;
                if (progress > 100) {
                    clearInterval(interval);
                    finetuningStatus.textContent = 'Finetuning not yet implemented.';
                    finetuningStatus.classList.remove('alert-info');
                    finetuningStatus.classList.add('alert-warning');
                    submitBtn.disabled = false;
                    return;
                }
                
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                
                if (progress < 20) {
                    finetuningStatus.textContent = 'Loading base model...';
                } else if (progress < 40) {
                    finetuningStatus.textContent = 'Preparing dataset...';
                } else if (progress < 90) {
                    finetuningStatus.textContent = 'Finetuning model (epoch ' + Math.floor((progress-40)/10) + ')...';
                } else {
                    finetuningStatus.textContent = 'Finalizing and saving model...';
                }
            }, 500);
            
            // In a real application, we would submit to the server and handle progress updates
            // via WebSockets or periodic AJAX calls
        });
    });
</script>
{% endblock %} 